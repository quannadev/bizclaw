<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BizClaw ‚Äî Agent Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#08090d;--bg2:#0d1017;--surface:#12151e;--surface2:#1a1e2e;--border:#1e2433;--border-hover:#2a3048;
  --text:#e8ecf4;--text2:#7c8599;--accent:#6366f1;--accent2:#818cf8;--accent-glow:rgba(99,102,241,.12);
  --green:#34d399;--red:#ef4444;--orange:#fb923c;--blue:#60a5fa;--cyan:#22d3ee;--pink:#f472b6;
  --grad1:linear-gradient(135deg,#6366f1,#8b5cf6);
  --radius:10px;--font:'Inter',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.6}
a{color:var(--accent2);text-decoration:none}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Layout */
.app{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh}
.main{padding:28px 36px;overflow-y:auto;height:100vh}

/* Sidebar */
.logo{padding:20px;display:flex;align-items:center;gap:10px;font-size:17px;font-weight:700;border-bottom:1px solid var(--border)}
.logo .icon{font-size:22px}
.logo .text{background:var(--grad1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav{flex:1;padding:8px}
.nav a{display:flex;align-items:center;gap:10px;padding:9px 14px;border-radius:8px;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;cursor:pointer}
.nav a:hover{background:var(--surface2);color:var(--text)}
.nav a.active{background:var(--accent-glow);color:var(--accent2)}
.nav-sep{height:1px;background:var(--border);margin:8px 12px}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}

/* Header */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-header h1{font-size:22px;font-weight:700}
.page-header .sub{font-size:13px;color:var(--text2)}

/* Cards & Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.card:hover{border-color:var(--border-hover)}
.card-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:600}
.card-value{font-size:26px;font-weight:700}
.card-sub{font-size:11px;color:var(--text2);margin-top:3px}

/* Colors */
.green{color:var(--green)}.red{color:var(--red)}.orange{color:var(--orange)}.blue{color:var(--blue)}.accent{color:var(--accent2)}.cyan{color:var(--cyan)}

/* Forms */
.form-section{margin-bottom:28px}
.form-section h2{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.form-row{display:grid;grid-template-columns:160px 1fr;align-items:center;gap:12px;padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.form-label{font-size:12px;color:var(--text2);font-weight:500}
.form-row input,.form-row select,.form-row textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .2s}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{border-color:var(--accent)}
.form-row textarea{min-height:60px;resize:vertical;font-family:var(--mono);font-size:12px}

/* Buttons */
.btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:var(--font)}
.btn-primary{background:var(--grad1);color:#fff}
.btn-primary:hover{box-shadow:0 4px 16px rgba(99,102,241,.35);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent2)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-green{background:#059669;color:#fff}.btn-green:hover{background:#047857}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.9}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-green{background:rgba(52,211,153,.12);color:var(--green)}
.badge-blue{background:rgba(96,165,250,.12);color:var(--blue)}
.badge-orange{background:rgba(251,146,60,.12);color:var(--orange)}
.badge-red{background:rgba(239,68,68,.12);color:var(--red)}
.badge-purple{background:rgba(99,102,241,.12);color:var(--accent2)}

/* Tables */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
tr:hover td{background:rgba(255,255,255,.02)}

/* Chat */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 120px)}
.chat-messages{flex:1;overflow-y:auto;padding:12px 0;display:flex;flex-direction:column;gap:10px}
.msg{max-width:72%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;animation:fadeIn .2s}
.msg-user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;white-space:pre-wrap;font-family:var(--font)}
.msg-system{align-self:center;font-size:11px;color:var(--text2);font-style:italic}
.chat-input-wrap{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border)}
.chat-input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 16px;color:var(--text);font-size:13px;outline:none}
.chat-input-wrap input:focus{border-color:var(--accent)}
.chat-input-wrap button{background:var(--grad1);color:#fff;border:none;border-radius:8px;padding:11px 20px;font-size:13px;cursor:pointer;font-weight:600}
.typing{color:var(--text2);font-size:12px;padding:4px 0}

/* Channel cards */
.ch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.ch-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.ch-card:hover{border-color:var(--border-hover)}
.ch-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.ch-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
.ch-fields{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.ch-fields label{font-size:11px;color:var(--text2);font-weight:500}
.ch-fields input,.ch-fields textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--mono)}
.ch-fields input:focus,.ch-fields textarea:focus{border-color:var(--accent)}
.ch-fields textarea{min-height:50px;resize:vertical}
.ch-actions{display:flex;gap:6px;flex-wrap:wrap}
.toggle{position:relative;width:36px;height:20px;display:inline-block}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:.2s}
.toggle .slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked + .slider{background:var(--accent)}
.toggle input:checked + .slider::before{transform:translateX(16px)}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-size:13px;z-index:999;animation:slideUp .3s;box-shadow:0 8px 32px rgba(0,0,0,.4)}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 1.5s infinite}

/* Responsive */
@media(max-width:768px){.app{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- Pairing Gate -->
<div id="pairing-gate" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:300;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:380px;text-align:center">
    <div style="font-size:32px;margin-bottom:12px">üîê</div>
    <h2 style="color:var(--accent);margin-bottom:8px">BizClaw Agent</h2>
    <p style="color:var(--text2);font-size:13px;margin-bottom:24px">Nh·∫≠p m√£ Pairing Code ƒë·ªÉ truy c·∫≠p Dashboard</p>
    <div id="pairing-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
    <input id="pairing-input" type="text" placeholder="Pairing Code (6 digits)" maxlength="10" style="width:100%;padding:12px 16px;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;text-align:center;letter-spacing:4px;font-family:var(--mono)" onkeydown="if(event.key==='Enter')doPairing()">
    <button style="width:100%;padding:12px;background:var(--grad1);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer" onclick="doPairing()">üîì X√°c nh·∫≠n</button>
  </div>
</div>

<div id="app-container" class="app">
  <aside class="sidebar">
    <div class="logo"><span class="icon">‚ö°</span><span class="text">BizClaw</span></div>
    <nav class="nav">
      <a href="/dashboard" onclick="navigateTo(event,'dashboard')" class="active" id="nav-dashboard">üìä <span data-i18n="nav.dashboard">B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a>
      <a href="/chat" onclick="navigateTo(event,'chat')" id="nav-chat">üí¨ <span data-i18n="nav.webchat">Tr√≤ chuy·ªán</span></a>
      <div class="nav-sep"></div>
      <a href="/settings" onclick="navigateTo(event,'settings')" id="nav-settings">‚öôÔ∏è <span data-i18n="nav.settings">C√†i ƒë·∫∑t</span></a>
      <a href="/providers" onclick="navigateTo(event,'providers')" id="nav-providers">üîå <span data-i18n="nav.providers">Nh√† cung c·∫•p</span></a>
      <a href="/channels" onclick="navigateTo(event,'channels')" id="nav-channels">üì± <span data-i18n="nav.channels">K√™nh li√™n l·∫°c</span></a>
      <a href="/tools" onclick="navigateTo(event,'tools')" id="nav-tools">üõ†Ô∏è <span data-i18n="nav.tools">C√¥ng c·ª•</span></a>
      <a href="/mcp" onclick="navigateTo(event,'mcp')" id="nav-mcp">üîó MCP Servers</a>
      <a href="/agents" onclick="navigateTo(event,'agents')" id="nav-agents">ü§ñ Multi-Agent</a>
      <a href="/knowledge" onclick="navigateTo(event,'knowledge')" id="nav-knowledge">üìö Knowledge</a>
      <div class="nav-sep"></div>
      <a href="/brain" onclick="navigateTo(event,'brain')" id="nav-brain">üß† <span data-i18n="nav.brain">Brain Engine</span></a>
      <a href="/configfile" onclick="navigateTo(event,'configfile')" id="nav-configfile">üìÑ config.toml</a>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <button onclick="setLang('vi')" id="btn-vi" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer">VI</button>
        <button onclick="setLang('en')" id="btn-en" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer">EN</button>
      </div>
      <div id="ws-status">‚¨ú <span data-i18n="status.disconnected">ƒê√£ ng·∫Øt k·∫øt n·ªëi</span></div>
      <div style="margin-top:4px" id="agent-name">BizClaw Agent</div>
    </div>
  </aside>
  <main class="main">
    <!-- ‚ïê‚ïê‚ïê DASHBOARD (LobsterBoard-inspired) ‚ïê‚ïê‚ïê -->
    <div id="page-dashboard">
      <div class="page-header"><div><h1 data-i18n="dash.title">B·∫£ng ƒëi·ªÅu khi·ªÉn</h1><div class="sub" data-i18n="dash.subtitle">Trung t√¢m qu·∫£n l√Ω Agent Gateway</div></div></div>
      <!-- Widget Row 1: Quick Stats -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
        <div class="card" style="text-align:center">
          <div class="card-label">‚è∞ Clock</div>
          <div class="card-value accent" id="w-clock" style="font-size:22px;font-family:var(--mono)">--:--</div>
          <div class="card-sub" id="w-date">‚Äî</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.uptime">Uptime</div>
          <div class="card-value green" id="s-uptime" style="font-size:22px">‚Äî</div>
          <div class="card-sub" data-i18n="dash.status">Online</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.provider">Provider</div>
          <div class="card-value blue" id="s-provider" style="font-size:18px">‚Äî</div>
          <div class="card-sub" id="s-model" style="color:var(--cyan)">‚Äî</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.version">Version</div>
          <div class="card-value accent" id="s-version" style="font-size:18px">‚Äî</div>
          <div class="card-sub" id="s-platform" style="font-size:10px">‚Äî</div>
        </div>
      </div>
      <!-- Widget Row 2: System & Channels -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
        <!-- System Info Widget -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="card-label" style="margin:0">üñ•Ô∏è System</div>
            <span class="badge badge-green" id="s-status">‚óè Online</span>
          </div>
          <div id="dash-system" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
            <div><span style="color:var(--text2)">OS:</span> <span id="sys-os">‚Äî</span></div>
            <div><span style="color:var(--text2)">Arch:</span> <span id="sys-arch">‚Äî</span></div>
            <div><span style="color:var(--text2)">SIMD:</span> <span id="brain-simd" style="color:var(--accent2)">‚Äî</span></div>
            <div><span style="color:var(--text2)">Memory:</span> <span id="sys-mem">‚Äî</span></div>
          </div>
        </div>
        <!-- Quick Actions Widget -->
        <div class="card">
          <div class="card-label" style="margin-bottom:10px">‚ö° Quick Actions</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'chat')">üí¨ Chat</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'settings')">‚öôÔ∏è Settings</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'channels')">üì± Channels</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'brain')">üß† Brain</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'configfile')">üìÑ Config</button>
          </div>
        </div>
      </div>
      <!-- Widget Row 3: Channel Table -->
      <div class="card">
        <div class="card-label" style="margin-bottom:10px">üì° <span data-i18n="dash.channels">Active Channels</span></div>
        <table><thead><tr><th data-i18n="th.channel">K√™nh</th><th data-i18n="th.type">Lo·∫°i</th><th data-i18n="th.status">Tr·∫°ng th√°i</th><th data-i18n="th.configured">Config</th></tr></thead><tbody id="dash-channels"></tbody></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê WEBCHAT ‚ïê‚ïê‚ïê -->
    <div id="page-chat" style="display:none">
      <div class="page-header"><h1>üí¨ <span data-i18n="chat.title">Tr√≤ chuy·ªán</span></h1></div>
      <div class="chat-wrap">
        <div class="chat-messages" id="chat-messages">
          <div class="msg msg-system" data-i18n="chat.welcome">ƒê√£ k·∫øt n·ªëi BizClaw. Nh·∫≠p tin nh·∫Øn ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán.</div>
        </div>
        <div class="typing" id="chat-typing" style="display:none"><span data-i18n="chat.thinking">BizClaw ƒëang suy nghƒ©</span><span class="pulse">...</span></div>
        <div class="chat-input-wrap">
          <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." data-i18n-placeholder="chat.placeholder" onkeydown="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" data-i18n="chat.send">G·ª≠i ‚Üë</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê -->
    <div id="page-settings" style="display:none">
      <div class="page-header"><div><h1>‚öôÔ∏è Agent Settings</h1><div class="sub">Configure your AI agent ‚Äî provider, model, identity, security</div></div>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
      </div>
      <div class="form-section">
        <h2>ü§ñ AI Provider</h2>
        <div class="form-row"><span class="form-label">Provider</span><select id="set-provider" onchange="onProviderChange()">
          <option value="openai">OpenAI</option><option value="anthropic">Anthropic</option>
          <option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option>
          <option value="groq">Groq</option><option value="ollama">Ollama (local)</option>
          <option value="llamacpp">llama.cpp</option><option value="brain">Brain Engine (offline)</option>
        </select></div>
        <!-- Cloud provider fields -->
        <div id="provider-cloud-fields">
          <div class="form-row"><span class="form-label">Model</span><input id="set-model" placeholder="gpt-4o-mini"></div>
          <div class="form-row"><span class="form-label">API Key</span><input id="set-apikey" type="password" placeholder="sk-..."></div>
        </div>
        <!-- Ollama fields -->
        <div id="provider-ollama-fields" style="display:none">
          <div class="form-row"><span class="form-label">Model</span>
            <div style="display:flex;gap:8px;flex:1">
              <select id="set-ollama-model" style="flex:1"><option value="">Loading models...</option></select>
              <button class="btn btn-outline btn-sm" onclick="loadOllamaModels()" title="Refresh models">üîÑ</button>
            </div>
          </div>
          <div id="ollama-status-row" class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">üí° Status</span><span id="ollama-status-msg" style="font-size:12px;color:var(--text2)">Checking Ollama...</span></div>
        </div>
        <!-- Brain Engine fields -->
        <div id="provider-brain-fields" style="display:none">
          <div class="form-row"><span class="form-label">Model Path</span>
            <div style="display:flex;gap:8px;flex:1">
              <input id="set-brain-path" placeholder="~/.bizclaw/models/tinyllama.gguf" style="flex:1">
              <button class="btn btn-outline btn-sm" onclick="scanBrainModels()" title="Scan for GGUF models">üìÇ Scan</button>
            </div>
          </div>
          <div id="brain-models-found" style="display:none;margin:-8px 0 8px 0">
            <div style="font-size:11px;color:var(--text2);margin-bottom:4px">Found GGUF models ‚Äî click to select:</div>
            <div id="brain-models-list" style="display:flex;flex-wrap:wrap;gap:4px"></div>
          </div>
          <div class="form-row"><span class="form-label">Threads</span><input id="set-brain-threads" type="number" min="1" max="32" value="4" placeholder="4"></div>
          <div class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">üß† Brain</span><span style="font-size:12px;color:var(--text2)">GGUF models run 100% offline. Download: <code style="color:var(--cyan)">bizclaw brain download tinyllama-1.1b</code></span></div>
        </div>
        <!-- llama.cpp fields -->
        <div id="provider-llamacpp-fields" style="display:none">
          <div class="form-row"><span class="form-label">Server URL</span><input id="set-llamacpp-url" placeholder="http://localhost:8080"></div>
          <div class="form-row"><span class="form-label">Model</span><input id="set-llamacpp-model" placeholder="(auto-detected)"></div>
        </div>
        <div class="form-row"><span class="form-label">Temperature</span><input id="set-temp" type="number" step="0.1" min="0" max="2" value="0.7"></div>
      </div>
      <div class="form-section">
        <h2>üé≠ Identity</h2>
        <div class="form-row"><span class="form-label">Agent Name</span><input id="set-name" placeholder="BizClaw"></div>
        <div class="form-row"><span class="form-label">Persona</span><input id="set-persona" placeholder="A helpful AI assistant"></div>
        <div class="form-row"><span class="form-label">System Prompt</span><textarea id="set-sysprompt" placeholder="You are BizClaw, a fast and capable AI assistant."></textarea></div>
      </div>
      <div class="form-section">
        <h2>üíæ Memory</h2>
        <div class="form-row"><span class="form-label">Backend</span><select id="set-mem-backend"><option value="sqlite">SQLite</option><option value="postgres">PostgreSQL</option><option value="none">None (NoOp)</option></select></div>
        <div class="form-row"><span class="form-label">Auto Save</span><select id="set-mem-autosave"><option value="true">Yes</option><option value="false">No</option></select></div>
      </div>
      <div class="form-section">
        <h2>üîí Security / Autonomy</h2>
        <div class="form-row"><span class="form-label">Autonomy Level</span><select id="set-auto-level"><option value="readonly">Read Only</option><option value="supervised">Supervised</option><option value="full">Full</option></select></div>
        <div class="form-row"><span class="form-label">Workspace Only</span><select id="set-auto-workspace"><option value="true">Yes</option><option value="false">No</option></select></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROVIDERS ‚ïê‚ïê‚ïê -->
    <div id="page-providers" style="display:none">
      <div class="page-header"><h1>üîå Providers</h1></div>
      <div class="card"><table><thead><tr><th>Provider</th><th>Type</th><th>Status</th><th>Models</th></tr></thead><tbody id="providers-table"></tbody></table></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CHANNELS ‚ïê‚ïê‚ïê -->
    <div id="page-channels" style="display:none">
      <div class="page-header"><div><h1>üì± Channel Configuration</h1><div class="sub">Connect your agent to messaging platforms</div></div></div>
      <div class="ch-grid" id="channels-grid"></div>
      <!-- Zalo QR Modal -->
      <div id="zalo-qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:420px;width:90%;text-align:center">
          <h2 style="margin-bottom:12px">üì± Zalo QR Login</h2>
          <div id="zalo-qr-content" style="margin:16px 0;min-height:100px"><div class="pulse" style="color:var(--text2)">ƒêang t·∫°o m√£ QR...</div></div>
          <div id="zalo-qr-instructions" style="font-size:12px;color:var(--text2);text-align:left;margin:12px 0"></div>
          <div id="zalo-qr-imei" style="font-size:11px;color:var(--text2);margin:8px 0"></div>
          <button class="btn btn-outline" onclick="closeZaloQR()" style="margin-top:12px">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TOOLS ‚ïê‚ïê‚ïê -->
    <div id="page-tools" style="display:none">
      <div class="page-header"><h1>üõ†Ô∏è Tools</h1></div>
      <div class="stats">
        <div class="card"><div class="card-label">Shell</div><div class="card-value green">‚óè Active</div><div class="card-sub">Execute system commands (sandboxed)</div></div>
        <div class="card"><div class="card-label">File</div><div class="card-value green">‚óè Active</div><div class="card-sub">Read/write/list files</div></div>
        <div class="card"><div class="card-label">Web Search</div><div class="card-value green">‚óè Active</div><div class="card-sub">DuckDuckGo search</div></div>
        <div class="card"><div class="card-label">Calendar</div><div class="card-value orange">‚óè Available</div><div class="card-sub">Google Calendar integration</div></div>
        <div class="card"><div class="card-label">Document Reader</div><div class="card-value green">‚óè Active</div><div class="card-sub">PDF, DOCX, Excel, CSV extraction</div></div>
        <div class="card"><div class="card-label">Group Summarizer</div><div class="card-value green">‚óè Active</div><div class="card-sub">Zalo/Telegram group message summary</div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MCP SERVERS ‚ïê‚ïê‚ïê -->
    <div id="page-mcp" style="display:none">
      <div class="page-header"><div><h1>üîó MCP Servers</h1><div class="sub">Model Context Protocol ‚Äî extend your agent with external tools</div></div>
        <button class="btn btn-primary" onclick="showMcpForm()">+ Add Server</button>
      </div>
      <div class="stats" id="mcp-stats">
        <div class="card"><div class="card-label">Total Servers</div><div class="card-value accent" id="mcp-total">0</div></div>
        <div class="card"><div class="card-label">Active</div><div class="card-value green" id="mcp-active">0</div></div>
        <div class="card"><div class="card-label">Protocol</div><div class="card-value blue">MCP v2024-11-05</div></div>
      </div>
      <div id="mcp-list" class="ch-grid" style="margin-top:16px"></div>
      <!-- Add MCP Server Form (hidden) -->
      <div id="mcp-add-form" class="card" style="display:none;margin-top:16px">
        <h3>‚ûï Add MCP Server</h3>
        <label>Name</label>
        <input id="mcp-name" placeholder="e.g. filesystem, github, memory">
        <label>Command</label>
        <input id="mcp-command" placeholder="e.g. npx, uvx, node">
        <label>Arguments (comma-separated)</label>
        <input id="mcp-args" placeholder="e.g. -y,@modelcontextprotocol/server-filesystem,/home">
        <label>Environment Variables (KEY=VALUE, one per line)</label>
        <textarea id="mcp-env" rows="3" placeholder="GITHUB_TOKEN=ghp_xxx&#10;API_KEY=sk-xxx"></textarea>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="addMcpServer()">üíæ Save</button>
          <button class="btn btn-outline" onclick="hideMcpForm()">Cancel</button>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <h3>üìñ Popular MCP Servers</h3>
        <table><thead><tr><th>Name</th><th>Command</th><th>Description</th></tr></thead><tbody>
          <tr><td><strong>Filesystem</strong></td><td><code>npx -y @modelcontextprotocol/server-filesystem /path</code></td><td>Read/write files</td></tr>
          <tr><td><strong>GitHub</strong></td><td><code>npx -y @modelcontextprotocol/server-github</code></td><td>Issues, PRs, repos</td></tr>
          <tr><td><strong>Memory</strong></td><td><code>npx -y @modelcontextprotocol/server-memory</code></td><td>Persistent memory</td></tr>
          <tr><td><strong>Brave Search</strong></td><td><code>npx -y @modelcontextprotocol/server-brave-search</code></td><td>Web search</td></tr>
          <tr><td><strong>Puppeteer</strong></td><td><code>npx -y @modelcontextprotocol/server-puppeteer</code></td><td>Browser automation</td></tr>
          <tr><td><strong>Postgres</strong></td><td><code>npx -y @modelcontextprotocol/server-postgres "postgresql://..."</code></td><td>Database queries</td></tr>
        </tbody></table>
        <div style="margin-top:8px;font-size:12px;color:var(--text2)">More at <a href="https://github.com/modelcontextprotocol/servers" target="_blank" style="color:var(--accent)">github.com/modelcontextprotocol/servers</a></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê BRAIN ENGINE ‚ïê‚ïê‚ïê -->
    <div id="page-brain" style="display:none">
      <div class="page-header"><h1>üß† Brain Engine</h1></div>
      <div class="stats">
        <div class="card"><div class="card-label">Engine</div><div class="card-value green">GGUF v3</div></div>
        <div class="card"><div class="card-label">SIMD</div><div class="card-value accent" id="brain-simd">‚Äî</div></div>
        <div class="card"><div class="card-label">Quantization</div><div class="card-value blue">Q4_0 / Q8_0 / F16</div></div>
        <div class="card"><div class="card-label">Features</div><div class="card-value cyan">Flash Attn + KV Cache</div></div>
      </div>
      <div class="form-section"><h2>Available Models</h2>
        <div class="card"><table><thead><tr><th>Model</th><th>Size</th><th>Download</th></tr></thead><tbody>
          <tr><td><strong>TinyLlama 1.1B</strong></td><td>~638 MB</td><td><code>bizclaw brain download tinyllama-1.1b</code></td></tr>
          <tr><td><strong>Phi-2</strong></td><td>~1.6 GB</td><td><code>bizclaw brain download phi-2</code></td></tr>
          <tr><td><strong>Llama 3.2 1B</strong></td><td>~750 MB</td><td><code>bizclaw brain download llama-3.2-1b</code></td></tr>
          <tr><td><strong>Qwen 3 0.6B</strong></td><td>~400 MB</td><td><code>bizclaw brain download qwen3-0.6b</code></td></tr>
        </tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê MULTI-AGENT ‚ïê‚ïê‚ïê -->
    <div id="page-agents" style="display:none">
      <div class="page-header"><div><h1>ü§ñ Multi-Agent Orchestrator</h1><div class="sub">Create and manage multiple AI agents with different roles</div></div>
        <button class="btn btn-primary" onclick="showCreateAgentForm()">+ Create Agent</button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label">Total Agents</div><div class="card-value accent" id="agents-total">0</div></div>
        <div class="card"><div class="card-label">Default Agent</div><div class="card-value green" id="agents-default">‚Äî</div></div>
        <div class="card"><div class="card-label">Messages</div><div class="card-value blue" id="agents-messages">0</div></div>
      </div>
      <!-- Create Agent Form -->
      <div id="agent-create-form" class="card" style="display:none;margin-top:16px">
        <h3>‚ûï Create New Agent</h3>
        <div class="form-row"><span class="form-label">Name</span><input id="new-agent-name" placeholder="researcher"></div>
        <div class="form-row"><span class="form-label">Role</span><select id="new-agent-role">
          <option value="assistant">Assistant</option><option value="researcher">Researcher</option>
          <option value="coder">Coder</option><option value="writer">Writer</option>
          <option value="analyst">Analyst</option><option value="translator">Translator</option>
        </select></div>
        <div class="form-row"><span class="form-label">Description</span><input id="new-agent-desc" placeholder="A helpful research agent"></div>
        <div class="form-row"><span class="form-label">System Prompt</span><textarea id="new-agent-prompt" placeholder="You are a specialized research agent..."></textarea></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="createAgent()">ü§ñ Create</button>
          <button class="btn btn-outline" onclick="document.getElementById('agent-create-form').style.display='none'">Cancel</button>
        </div>
      </div>
      <div id="agents-list" class="ch-grid" style="margin-top:16px"></div>
      <!-- Broadcast -->
      <div class="card" style="margin-top:16px">
        <h3>üì¢ Broadcast Message</h3>
        <div class="form-row"><span class="form-label">Message</span><input id="broadcast-msg" placeholder="Send to all agents..."></div>
        <button class="btn btn-primary btn-sm" onclick="broadcastMessage()">üì¢ Send to All</button>
        <div id="broadcast-results" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê KNOWLEDGE BASE ‚ïê‚ïê‚ïê -->
    <div id="page-knowledge" style="display:none">
      <div class="page-header"><div><h1>üìö Knowledge Base</h1><div class="sub">Personal RAG ‚Äî add documents for context-aware AI responses</div></div>
        <button class="btn btn-primary" onclick="showAddDocForm()">+ Add Document</button>
      </div>
      <div class="stats">
        <div class="card"><div class="card-label">Documents</div><div class="card-value accent" id="kb-docs">0</div></div>
        <div class="card"><div class="card-label">Chunks</div><div class="card-value blue" id="kb-chunks">0</div></div>
        <div class="card"><div class="card-label">Search Engine</div><div class="card-value green">FTS5</div></div>
      </div>
      <!-- Search -->
      <div class="card" style="margin-top:16px">
        <h3>üîç Search Knowledge</h3>
        <div style="display:flex;gap:8px"><input id="kb-search-input" placeholder="Search your documents..." style="flex:1" onkeydown="if(event.key==='Enter')searchKnowledge()"><button class="btn btn-primary btn-sm" onclick="searchKnowledge()">Search</button></div>
        <div id="kb-search-results" style="margin-top:12px"></div>
      </div>
      <!-- Add Document Form -->
      <div id="kb-add-form" class="card" style="display:none;margin-top:16px">
        <h3>‚ûï Add Document</h3>
        <div class="form-row"><span class="form-label">Name</span><input id="kb-doc-name" placeholder="meeting_notes.txt"></div>
        <div class="form-row"><span class="form-label">Source</span><input id="kb-doc-source" placeholder="manual" value="dashboard"></div>
        <div class="form-row"><span class="form-label">Content</span><textarea id="kb-doc-content" rows="6" placeholder="Paste document content here..."></textarea></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="addDocument()">üíæ Save</button>
          <button class="btn btn-outline" onclick="document.getElementById('kb-add-form').style.display='none'">Cancel</button>
        </div>
      </div>
      <!-- Document List -->
      <div class="card" style="margin-top:16px">
        <h3>üìÑ Documents</h3>
        <div id="kb-doc-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONFIG FILE ‚ïê‚ïê‚ïê -->
    <div id="page-configfile" style="display:none">
      <div class="page-header"><div><h1>üìÑ config.toml</h1><div class="sub" id="config-path">‚Äî</div></div></div>
      <div class="card"><pre id="config-toml-content" style="font-family:var(--mono);font-size:12px;line-height:1.7;color:var(--accent2);white-space:pre-wrap;max-height:70vh;overflow-y:auto;padding:4px">Loading...</pre></div>
    </div>
  </main>
</div>

<script>
const API = '';
let ws = null, configData = {};
let pairingCode = sessionStorage.getItem('bizclaw_pairing')||'';

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function authHeaders(extra={}){
  return {...extra,'X-Pairing-Code':pairingCode,'Content-Type':'application/json'};
}
async function authFetch(url,opts={}){
  if(!opts.headers) opts.headers={};
  opts.headers['X-Pairing-Code']=pairingCode;
  const res=await fetch(url,opts);
  if(res.status===401){sessionStorage.removeItem('bizclaw_pairing');pairingCode='';showPairingGate();throw new Error('Invalid pairing code');}
  return res;
}
function showPairingGate(){
  document.getElementById('pairing-gate').style.display='flex';
  document.getElementById('app-container').style.display='none';
}
function hidePairingGate(){
  document.getElementById('pairing-gate').style.display='none';
  document.getElementById('app-container').style.display='grid';
}
async function doPairing(){
  const code=document.getElementById('pairing-input').value.trim();
  const errEl=document.getElementById('pairing-error');
  errEl.style.display='none';
  if(!code){errEl.textContent='Vui l\xf2ng nh\u1eadp m\xe3 pairing';errEl.style.display='block';return;}
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
    const r=await res.json();
    if(r.ok){pairingCode=code;sessionStorage.setItem('bizclaw_pairing',code);hidePairingGate();initApp();}
    else{errEl.textContent=r.error||'Sai m\xe3 pairing';errEl.style.display='block';}
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
}
async function checkPairing(){
  // First check if pairing is required at all
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:''})});
    const r=await res.json();
    if(r.ok){hidePairingGate();initApp();return;} // no pairing required
  }catch(e){}
  if(pairingCode){
    try{const r=await(await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:pairingCode})})).json();
      if(r.ok){hidePairingGate();initApp();return;}
    }catch(e){}
  }
  showPairingGate();
}

// ‚ïê‚ïê‚ïê NAVIGATION (Path Router ‚Äî History API) ‚ïê‚ïê‚ïê
function navigateTo(event, name) {
  if (event) event.preventDefault();
  showPage(name, true);
}

function showPage(name, pushState) {
  // Update URL path using History API
  const targetPath = '/' + (name === 'dashboard' ? '' : name);
  if (pushState !== false && location.pathname !== targetPath && !(name === 'dashboard' && location.pathname === '/')) {
    history.pushState({ page: name }, '', targetPath);
  }
  document.querySelectorAll('[id^=page-]').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  const nav = document.getElementById('nav-' + name);
  if (page) page.style.display = '';
  if (nav) nav.classList.add('active');
  if (name === 'chat') document.getElementById('chat-input').focus();
  if (name === 'settings') loadSettingsForm();
  if (name === 'channels') renderChannelCards();
  if (name === 'configfile') loadConfigToml();
  if (name === 'mcp') loadMcpServers();
  if (name === 'agents') loadAgents();
  if (name === 'knowledge') loadKnowledgeDocs();
}

// Handle browser back/forward
window.addEventListener('popstate', (ev) => {
  const name = getPageFromPath();
  showPage(name, false);
});

// Get page name from current URL pathname
function getPageFromPath() {
  const path = location.pathname.replace(/^\//, '').replace(/\/$/, '');
  // Map valid page names
  const validPages = ['dashboard','chat','settings','providers','channels','tools','brain','configfile','mcp','agents','knowledge'];
  if (!path || path === '' || !validPages.includes(path)) return 'dashboard';
  return path;
}

// Route from current path on load
function routeFromPath() {
  const name = getPageFromPath();
  showPage(name, false);
}

// ‚ïê‚ïê‚ïê DASHBOARD (widget-based) ‚ïê‚ïê‚ïê
function updateClock() {
  const now = new Date();
  const el = document.getElementById('w-clock');
  const dt = document.getElementById('w-date');
  if(el) el.textContent = now.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(dt) dt.textContent = now.toLocaleDateString(currentLang==='vi'?'vi-VN':'en-US',{weekday:'short',month:'short',day:'numeric'});
}
setInterval(updateClock, 1000);

async function loadDashboard() {
  updateClock();
  try {
    const info = await (await authFetch(API + '/api/v1/info')).json();
    document.getElementById('s-version').textContent = 'v' + (info.version||'?');
    document.getElementById('s-provider').textContent = info.default_provider || '‚Äî';
    document.getElementById('s-model').textContent = info.default_model || '‚Äî';
    document.getElementById('s-uptime').textContent = fmtUptime(info.uptime_secs);
    document.getElementById('s-platform').textContent = info.platform || '‚Äî';
    document.getElementById('agent-name').textContent = (info.name || 'BizClaw') + ' Agent';
    const arch = info.platform || '';
    document.getElementById('brain-simd').textContent = arch.includes('aarch64') ? 'NEON' : arch.includes('x86') ? 'AVX2/SSE2' : 'Auto';
    // Parse system info
    const parts = arch.split('-');
    const sysOs = document.getElementById('sys-os');
    const sysArch = document.getElementById('sys-arch');
    if(sysOs) sysOs.textContent = parts.length >= 2 ? parts.slice(1).join('-') : arch;
    if(sysArch) sysArch.textContent = parts[0] || '‚Äî';
  } catch(e) {}
  try {
    const ch = await (await authFetch(API + '/api/v1/channels')).json();
    document.getElementById('dash-channels').innerHTML = ch.channels.map(c => `<tr>
      <td><strong>${c.name}</strong></td><td>${c.type}</td>
      <td><span class="badge badge-${c.status==='active'?'green':c.status==='disabled'?'orange':'blue'}">${c.status}</span></td>
      <td>${c.configured?'‚úÖ':'‚Äî'}</td>
    </tr>`).join('');
  } catch(e) {}
}

async function loadProviders() {
  try {
    const data = await (await authFetch(API + '/api/v1/providers')).json();
    document.getElementById('providers-table').innerHTML = data.providers.map(p => `<tr>
      <td><strong>${p.name}</strong></td><td>${p.type}</td>
      <td><span class="badge badge-${p.status==='active'?'green':'blue'}">${p.status}</span></td>
      <td style="font-size:12px;color:var(--text2)">${(p.models||[]).join(', ')}</td>
    </tr>`).join('');
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
async function loadConfig() {
  try {
    configData = await (await authFetch(API + '/api/v1/config')).json();
  } catch(e) { configData = {}; }
}

// Scan for GGUF model files using real API
async function scanBrainModels() {
  const listEl = document.getElementById('brain-models-list');
  const wrapEl = document.getElementById('brain-models-found');
  listEl.innerHTML = '<span style="color:var(--text2)">Scanning filesystem for GGUF models...</span>';
  wrapEl.style.display = '';
  try {
    const res = await authFetch(API + '/api/v1/brain/models');
    const data = await res.json();
    if (!data.ok) {
      listEl.innerHTML = `<span style="color:var(--red)">Error: ${data.error || 'Unknown error'}</span>`;
      return;
    }
    
    const currentPath = document.getElementById('set-brain-path').value;
    const models = data.models || [];
    
    if (models.length === 0) {
      listEl.innerHTML = `<div style="width:100%;font-size:12px">
        <span style="color:var(--text2)">No GGUF models found.</span><br>
        <span style="font-size:11px;color:var(--text2)">Download a model: <code style="color:var(--cyan)">bizclaw brain download tinyllama-1.1b</code></span><br>
        <span style="font-size:11px;color:var(--text2)">Models directory: <code>${data.models_dir}</code></span>
      </div>`;
      return;
    }
    
    listEl.innerHTML = models.map(m => {
      const isActive = m.path === currentPath;
      return `<button class="btn ${isActive ? 'btn-primary' : 'btn-outline'} btn-sm" 
        onclick="document.getElementById('set-brain-path').value='${m.path}'" 
        style="font-size:11px" title="${m.path}">${m.name} (${m.size})</button>`;
    }).join('') + `<div style="width:100%;font-size:11px;color:var(--text2);margin-top:4px">
      üìÅ Found ${models.length} model(s) in: ${(data.scan_dirs || []).join(', ')}
    </div>`;
  } catch(e) {
    listEl.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
  }
}

// Provider-specific form visibility
function onProviderChange() {
  const provider = document.getElementById('set-provider').value;
  // Hide all provider-specific sections
  ['cloud','ollama','brain','llamacpp'].forEach(id => {
    const el = document.getElementById('provider-'+id+'-fields');
    if(el) el.style.display = 'none';
  });
  // Show the relevant one
  if (provider === 'brain') {
    document.getElementById('provider-brain-fields').style.display = '';
  } else if (provider === 'ollama') {
    document.getElementById('provider-ollama-fields').style.display = '';
    loadOllamaModels();
  } else if (provider === 'llamacpp') {
    document.getElementById('provider-llamacpp-fields').style.display = '';
  } else {
    document.getElementById('provider-cloud-fields').style.display = '';
  }
}

let _ollamaModelsLoaded = false;
async function loadOllamaModels() {
  const sel = document.getElementById('set-ollama-model');
  const statusEl = document.getElementById('ollama-status-msg');
  const currentModel = configData.default_provider === 'ollama' ? configData.default_model : '';
  sel.innerHTML = '<option value="">‚è≥ Loading...</option>';
  statusEl.textContent = 'Checking Ollama...';
  try {
    const res = await authFetch(API + '/api/v1/ollama/models');
    const r = await res.json();
    if (r.ok && r.models && r.models.length > 0) {
      sel.innerHTML = r.models.map(m =>
        `<option value="${m.name}" ${m.name === currentModel ? 'selected' : ''}>${m.name} (${m.size})</option>`
      ).join('');
      statusEl.innerHTML = `<span style="color:var(--green)">‚úÖ Ollama running ‚Äî ${r.models.length} models available</span>`;
      _ollamaModelsLoaded = true;
    } else if (r.ok && (!r.models || r.models.length === 0)) {
      sel.innerHTML = '<option value="">No models installed</option>';
      statusEl.innerHTML = '<span style="color:var(--orange)">‚ö†Ô∏è Ollama running but no models. Run: <code style="color:var(--cyan)">ollama pull tinyllama</code></span>';
    } else {
      sel.innerHTML = '<option value="">Ollama not available</option>';
      statusEl.innerHTML = `<span style="color:var(--red)">‚ùå ${r.error || 'Cannot connect to Ollama'}</span>`;
    }
  } catch(e) {
    sel.innerHTML = '<option value="">Connection error</option>';
    statusEl.innerHTML = `<span style="color:var(--red)">‚ùå ${e.message}</span>`;
  }
}

function loadSettingsForm() {
  const c = configData;
  if (!c.default_provider) return;
  const provider = c.default_provider || 'openai';
  document.getElementById('set-provider').value = provider;
  document.getElementById('set-temp').value = c.default_temperature || 0.7;
  // Fill model & API key for cloud providers
  document.getElementById('set-model').value = c.default_model || '';
  document.getElementById('set-apikey').value = c.api_key_set ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
  // Fill Brain fields
  const brain = c.brain || {};
  document.getElementById('set-brain-path').value = brain.model_path || '';
  document.getElementById('set-brain-threads').value = brain.threads || 4;
  // Toggle visibility (also triggers loadOllamaModels if provider is ollama)
  onProviderChange();
  // After loading ollama models, select the current one
  if (provider === 'ollama' && c.default_model) {
    // Wait for models to load then select
    setTimeout(() => {
      const sel = document.getElementById('set-ollama-model');
      if (sel) sel.value = c.default_model;
    }, 1500);
  }
  // Identity
  const id = c.identity || {};
  document.getElementById('set-name').value = id.name || '';
  document.getElementById('set-persona').value = id.persona || '';
  document.getElementById('set-sysprompt').value = id.system_prompt || '';
  // Memory
  const mem = c.memory || {};
  document.getElementById('set-mem-backend').value = mem.backend || 'sqlite';
  document.getElementById('set-mem-autosave').value = String(mem.auto_save !== false);
  // Autonomy
  const auto = c.autonomy || {};
  document.getElementById('set-auto-level').value = auto.level || 'supervised';
  document.getElementById('set-auto-workspace').value = String(auto.workspace_only !== false);
}

async function saveSettings() {
  const provider = document.getElementById('set-provider').value;
  let modelVal = '';
  if (provider === 'brain') {
    modelVal = 'brain-local';
  } else if (provider === 'ollama') {
    modelVal = document.getElementById('set-ollama-model').value;
  } else if (provider === 'llamacpp') {
    modelVal = document.getElementById('set-llamacpp-model').value;
  } else {
    modelVal = document.getElementById('set-model').value;
  }
  const body = {
    default_provider: provider,
    default_model: modelVal,
    default_temperature: parseFloat(document.getElementById('set-temp').value),
    identity: {
      name: document.getElementById('set-name').value,
      persona: document.getElementById('set-persona').value,
      system_prompt: document.getElementById('set-sysprompt').value,
    },
    memory: {
      backend: document.getElementById('set-mem-backend').value,
      auto_save: document.getElementById('set-mem-autosave').value === 'true',
    },
    autonomy: {
      level: document.getElementById('set-auto-level').value,
      workspace_only: document.getElementById('set-auto-workspace').value === 'true',
    },
  };
  // Provider-specific fields ‚Äî always send brain config to persist model_path
  if (provider === 'brain') {
    body.brain = {
      enabled: true,
      model_path: document.getElementById('set-brain-path').value,
      threads: parseInt(document.getElementById('set-brain-threads').value) || 4,
    };
  }
  const apiKeyVal = document.getElementById('set-apikey').value;
  if (apiKeyVal && !apiKeyVal.startsWith('‚Ä¢') && !['brain','ollama','llamacpp'].includes(provider)) {
    body.api_key = apiKeyVal;
  }
  try {
    const res = await authFetch(API + '/api/v1/config/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    if (r.ok) {
      toast('‚úÖ Settings saved! Agent reloading...');
      // Reload config from server to ensure UI shows persisted values
      await loadConfig();
      loadSettingsForm();
      loadDashboard();
    } else {
      toast('‚ùå ' + r.error);
    }
  } catch(e) { toast('‚ùå ' + e.message); }
}

// ‚ïê‚ïê‚ïê CHANNELS ‚ïê‚ïê‚ïê
const CHANNELS = [
  {type:'telegram',name:'Telegram Bot',icon:'ü§ñ',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'123456:ABC-DEF...', masked:true},
    {key:'allowed_chat_ids',label:'Allowed Chat IDs',type:'text',placeholder:'123456789, -100123...'},
  ]},
  {type:'zalo',name:'Zalo Personal',icon:'üí¨',hasQR:true,fields:[
    {key:'cookie',label:'Zalo Cookie',type:'textarea',placeholder:'Paste cookie t·ª´ chat.zalo.me ‚Üí F12 ‚Üí Application ‚Üí Cookies'},
    {key:'imei',label:'IMEI',type:'text',placeholder:'T·ª± ƒë·ªông t·∫°o n·∫øu ƒë·ªÉ tr·ªëng'},
  ]},
  {type:'discord',name:'Discord Bot',icon:'üéÆ',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'MTk...', masked:true},
    {key:'allowed_channel_ids',label:'Channel IDs',type:'text',placeholder:'123456789, 987654321'},
  ]},
  {type:'email',name:'Email (SMTP)',icon:'üìß',fields:[
    {key:'smtp_host',label:'SMTP Host',type:'text',placeholder:'smtp.gmail.com'},
    {key:'smtp_port',label:'Port',type:'text',placeholder:'587'},
    {key:'smtp_user',label:'Username',type:'text',placeholder:'agent@company.com'},
    {key:'smtp_pass',label:'Password',type:'password',placeholder:'App password', masked:true},
  ]},
  {type:'whatsapp',name:'WhatsApp Business',icon:'üì≤',fields:[
    {key:'phone_number_id',label:'Phone Number ID',type:'text',placeholder:'Cloud API Phone ID'},
    {key:'access_token',label:'Access Token',type:'password',placeholder:'EAAG...', masked:true},
    {key:'webhook_verify_token',label:'Webhook Verify Token',type:'text',placeholder:'my_verify_token'},
  ]},
  {type:'webhook',name:'Webhook API',icon:'üîó',fields:[
    {key:'webhook_url',label:'Inbound URL',type:'text',placeholder:'https://your-app.com/webhook'},
    {key:'webhook_secret',label:'Secret',type:'password',placeholder:'shared secret for HMAC'},
  ]},
];

function renderChannelCards() {
  const ch = configData.channels || {};
  document.getElementById('channels-grid').innerHTML = CHANNELS.map(def => {
    const saved = ch[def.type];
    const enabled = saved && saved.enabled !== undefined ? saved.enabled : false;
    return `<div class="ch-card">
      <div class="ch-header">
        <span class="ch-name">${def.icon} ${def.name}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge badge-${enabled?'green':'orange'}">${enabled?'Active':'Disabled'}</span>
          <label class="toggle"><input type="checkbox" id="ch-toggle-${def.type}" ${enabled?'checked':''}><span class="slider"></span></label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          let val = (saved && saved[f.key]) || '';
          // For masked fields (tokens/passwords), show indicator but keep actual input empty
          // so user can type new value. Don't pre-fill masked values.
          const isMaskedValue = f.masked && val && (val.includes('‚Ä¢') || val === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢');
          const indicator = isMaskedValue ? '<span style="font-size:10px;color:var(--green)"> ‚úÖ saved</span>' : (f.masked && saved && saved[f.key+'_set'] ? '<span style="font-size:10px;color:var(--green)"> ‚úÖ saved</span>' : '');
          const displayVal = isMaskedValue ? '' : val;
          if (f.type === 'textarea') return `<label>${f.label}${indicator}</label><textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${displayVal}</textarea>`;
          return `<label>${f.label}${indicator}</label><input type="${f.type}" id="ch-${def.type}-${f.key}" value="${displayVal}" placeholder="${f.placeholder}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">üíæ Save</button>
        ${def.hasQR ? '<button class="btn btn-green btn-sm" onclick="openZaloQR()">üì± Qu√©t m√£ QR</button>' : ''}
      </div>
    </div>`;
  }).join('');
}

async function saveChannel(type) {
  const def = CHANNELS.find(c => c.type === type);
  if (!def) return;
  const body = {
    channel_type: type,
    enabled: document.getElementById('ch-toggle-' + type)?.checked || false,
  };
  def.fields.forEach(f => {
    const el = document.getElementById('ch-' + type + '-' + f.key);
    if (el) body[f.key] = el.value;
  });
  try {
    const res = await authFetch(API + '/api/v1/channels/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    toast(r.ok ? `‚úÖ ${type} config saved` : '‚ùå ' + r.error);
    if (r.ok) { await loadConfig(); renderChannelCards(); }
  } catch(e) { toast('‚ùå ' + e.message); }
}

async function openZaloQR() {
  const modal = document.getElementById('zalo-qr-modal');
  modal.style.display = 'flex';
  document.getElementById('zalo-qr-content').innerHTML = '<div class="pulse" style="color:var(--text2)">ƒêang k·∫øt n·ªëi ƒë·∫øn Zalo...</div>';
  try {
    const res = await authFetch(API + '/api/v1/zalo/qr', {method:'POST',headers:{'Content-Type':'application/json'}});
    const r = await res.json();
    if (r.ok) {
      toast('‚úÖ M√£ QR ƒë√£ t·∫°o th√†nh c√¥ng! Qu√©t b·∫±ng Zalo.');
      document.getElementById('zalo-qr-content').innerHTML = r.qr_code.startsWith('data:') 
        ? `<img src="${r.qr_code}" style="max-width:280px;border-radius:12px;border:2px solid var(--accent)">`
        : `<div style="background:#fff;padding:16px;border-radius:12px;display:inline-block"><div style="font-family:var(--mono);font-size:11px;word-break:break-all;color:#333;max-width:260px">${r.qr_code}</div></div>`;
      document.getElementById('zalo-qr-instructions').innerHTML = (r.instructions||[]).map(i => `<div style="margin:3px 0">${i}</div>`).join('')
        + `<div style="margin-top:12px"><button class="btn btn-green" onclick="confirmZaloQR('${r.imei||''}')">‚úÖ X√°c nh·∫≠n ƒë√£ qu√©t th√†nh c√¥ng</button></div>`;
      document.getElementById('zalo-qr-imei').textContent = r.imei ? `IMEI: ${r.imei}` : '';
      // Auto-fill IMEI into channel card
      const imeiEl = document.getElementById('ch-zalo-imei');
      if (imeiEl && r.imei) imeiEl.value = r.imei;
    } else {
      document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">‚ùå ${r.error}</div><div style="margin-top:12px;font-size:12px;color:var(--text2)">${r.fallback||''}</div>`;
    }
  } catch(e) {
    document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">L·ªói k·∫øt n·ªëi: ${e.message}</div>`;
  }
}

async function confirmZaloQR(imei) {
  // Save zalo channel as enabled with the IMEI from QR
  const body = { channel_type: 'zalo', enabled: true, imei: imei };
  try {
    const res = await authFetch(API + '/api/v1/channels/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    if (r.ok) {
      toast('üéâ Zalo ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!');
      closeZaloQR();
      await loadConfig();
      renderChannelCards();
    } else {
      toast('‚ùå ' + r.error);
    }
  } catch(e) { toast('‚ùå ' + e.message); }
}

function closeZaloQR() {
  document.getElementById('zalo-qr-modal').style.display = 'none';
}

// ‚ïê‚ïê‚ïê CONFIG TOML ‚ïê‚ïê‚ïê
async function loadConfigToml() {
  try {
    const data = await (await authFetch(API + '/api/v1/config/full')).json();
    document.getElementById('config-toml-content').textContent = data.toml || 'No config loaded';
    document.getElementById('config-path').textContent = data.config_path || '';
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê MCP SERVERS ‚ïê‚ïê‚ïê
function loadMcpServers() {
  const servers = configData.mcp_servers || [];
  document.getElementById('mcp-total').textContent = servers.length;
  document.getElementById('mcp-active').textContent = servers.filter(s => s.enabled !== false).length;
  renderMcpList(servers);
}

function renderMcpList(servers) {
  const el = document.getElementById('mcp-list');
  if (!servers.length) {
    el.innerHTML = '<div class="card" style="text-align:center;padding:30px;color:var(--text2)">üîó No MCP servers configured yet.<br>Click "+ Add Server" to connect external tools.</div>';
    return;
  }
  el.innerHTML = servers.map((s, i) => `<div class="ch-card">
    <div class="ch-header">
      <span class="ch-name">üîó ${s.name}</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="badge badge-${s.enabled !== false ? 'green' : 'orange'}">${s.enabled !== false ? 'Active' : 'Disabled'}</span>
        <label class="toggle"><input type="checkbox" ${s.enabled !== false ? 'checked' : ''} onchange="toggleMcp(${i}, this.checked)"><span class="slider"></span></label>
      </div>
    </div>
    <div class="ch-fields" style="font-size:12px;">
      <div><strong>Command:</strong> <code>${s.command} ${(s.args||[]).join(' ')}</code></div>
      ${Object.keys(s.env||{}).length ? '<div><strong>Env:</strong> ' + Object.keys(s.env).map(k => k + '=‚Ä¢‚Ä¢‚Ä¢').join(', ') + '</div>' : ''}
    </div>
    <div class="ch-actions" style="margin-top:8px">
      <button class="btn btn-danger btn-sm" onclick="removeMcp(${i})">üóëÔ∏è Remove</button>
    </div>
  </div>`).join('');
}

function showMcpForm() { document.getElementById('mcp-add-form').style.display = ''; }
function hideMcpForm() { document.getElementById('mcp-add-form').style.display = 'none'; }

async function addMcpServer() {
  const name = document.getElementById('mcp-name').value.trim();
  const command = document.getElementById('mcp-command').value.trim();
  const argsStr = document.getElementById('mcp-args').value.trim();
  const envStr = document.getElementById('mcp-env').value.trim();
  if (!name || !command) { toast('Name and command are required', 'error'); return; }
  
  const args = argsStr ? argsStr.split(',').map(s => s.trim()).filter(Boolean) : [];
  const env = {};
  envStr.split('\n').forEach(line => {
    const [k, ...v] = line.split('=');
    if (k && v.length) env[k.trim()] = v.join('=').trim();
  });
  
  const servers = configData.mcp_servers || [];
  servers.push({ name, command, args, env, enabled: true });
  
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) {
      toast('‚úÖ MCP server added: ' + name);
      hideMcpForm();
      // Clear form
      ['mcp-name','mcp-command','mcp-args','mcp-env'].forEach(id => document.getElementById(id).value = '');
      await loadConfig();
      loadMcpServers();
    } else { toast('‚ùå ' + r.error, 'error'); }
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

async function removeMcp(index) {
  const servers = (configData.mcp_servers || []).filter((_, i) => i !== index);
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) { toast('üóëÔ∏è Server removed'); await loadConfig(); loadMcpServers(); }
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

async function toggleMcp(index, enabled) {
  const servers = configData.mcp_servers || [];
  if (servers[index]) servers[index].enabled = enabled;
  try {
    const res = await authFetch(API + '/api/v1/config/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ mcp_servers: servers })
    });
    const r = await res.json();
    if (r.ok) { toast(enabled ? '‚úÖ Server enabled' : '‚è∏ Server disabled'); await loadConfig(); loadMcpServers(); }
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê MULTI-AGENT ORCHESTRATOR ‚ïê‚ïê‚ïê
function showCreateAgentForm() { document.getElementById('agent-create-form').style.display = ''; }

async function loadAgents() {
  try {
    const res = await authFetch(API + '/api/v1/agents');
    const data = await res.json();
    if (!data.ok) return;
    
    document.getElementById('agents-total').textContent = data.total || 0;
    document.getElementById('agents-default').textContent = data.default || '‚Äî';
    document.getElementById('agents-messages').textContent = 
      (data.recent_messages || []).length;
    
    const list = document.getElementById('agents-list');
    if (!data.agents || data.agents.length === 0) {
      list.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--text2)"><div style="font-size:48px;margin-bottom:12px">ü§ñ</div><div>No agents yet. Click <b>+ Create Agent</b> to build your AI team.</div></div>';
      return;
    }
    
    list.innerHTML = data.agents.map(a => `
      <div class="card" style="position:relative">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:24px">${a.role === 'coder' ? 'üíª' : a.role === 'researcher' ? 'üî¨' : a.role === 'writer' ? '‚úçÔ∏è' : a.role === 'analyst' ? 'üìä' : a.role === 'translator' ? 'üåê' : 'ü§ñ'}</span>
          <div>
            <div style="font-weight:600;color:var(--text)">${a.name} ${a.is_default ? '<span style="font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:8px">DEFAULT</span>' : ''}</div>
            <div style="font-size:11px;color:var(--text2)">${a.role} ‚Ä¢ ${a.provider} ‚Ä¢ ${a.tools} tools</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text2)">${a.description}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:6px">üí¨ ${a.messages_processed} messages ‚Ä¢ üìù ${a.conversation_length} in context</div>
        <div style="display:flex;gap:6px;margin-top:10px">
          <input id="agent-msg-${a.name}" placeholder="Chat with ${a.name}..." style="flex:1;font-size:12px">
          <button class="btn btn-primary btn-sm" onclick="chatWithAgent('${a.name}')" style="font-size:11px">Send</button>
          <button class="btn btn-outline btn-sm" onclick="deleteAgent('${a.name}')" style="font-size:11px;color:var(--red)">üóëÔ∏è</button>
        </div>
        <div id="agent-response-${a.name}" style="margin-top:8px;font-size:12px;color:var(--cyan);display:none"></div>
      </div>
    `).join('');
  } catch(e) { console.error('Load agents:', e); }
}

async function createAgent() {
  const name = document.getElementById('new-agent-name').value.trim();
  const role = document.getElementById('new-agent-role').value;
  const desc = document.getElementById('new-agent-desc').value.trim();
  const prompt = document.getElementById('new-agent-prompt').value.trim();
  if (!name) { toast('Agent name is required', 'error'); return; }
  
  try {
    const res = await authFetch(API + '/api/v1/agents', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, role, description: desc || `A ${role} agent`, system_prompt: prompt || undefined })
    });
    const r = await res.json();
    if (r.ok) {
      toast(`ü§ñ Agent '${name}' created!`);
      document.getElementById('agent-create-form').style.display = 'none';
      ['new-agent-name','new-agent-desc','new-agent-prompt'].forEach(id => document.getElementById(id).value = '');
      loadAgents();
    } else { toast('‚ùå ' + r.error, 'error'); }
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

async function deleteAgent(name) {
  try {
    const res = await authFetch(API + `/api/v1/agents/${name}`, { method: 'DELETE' });
    const r = await res.json();
    toast(r.ok ? `üóëÔ∏è Agent '${name}' removed` : '‚ùå ' + r.message);
    loadAgents();
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

async function chatWithAgent(name) {
  const input = document.getElementById(`agent-msg-${name}`);
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  
  const respEl = document.getElementById(`agent-response-${name}`);
  respEl.style.display = '';
  respEl.innerHTML = '<span style="color:var(--text2)">Thinking...</span>';
  
  try {
    const res = await authFetch(API + `/api/v1/agents/${name}/chat`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg })
    });
    const r = await res.json();
    respEl.innerHTML = r.ok 
      ? `<div style="background:var(--bg);padding:8px;border-radius:8px;border:1px solid var(--border)">${r.response.replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>`
      : `<span style="color:var(--red)">‚ùå ${r.error}</span>`;
  } catch(e) { respEl.innerHTML = `<span style="color:var(--red)">‚ùå ${e.message}</span>`; }
}

async function broadcastMessage() {
  const msg = document.getElementById('broadcast-msg').value.trim();
  if (!msg) { toast('Enter a message to broadcast', 'error'); return; }
  
  const el = document.getElementById('broadcast-results');
  el.innerHTML = '<span style="color:var(--text2)">Broadcasting...</span>';
  
  try {
    const res = await authFetch(API + '/api/v1/agents/broadcast', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg })
    });
    const r = await res.json();
    if (r.ok) {
      el.innerHTML = r.responses.map(resp => `
        <div style="margin-top:8px;padding:8px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
          <div style="font-weight:600;color:${resp.ok ? 'var(--cyan)' : 'var(--red)'}">${resp.agent}</div>
          <div style="font-size:12px;margin-top:4px">${(resp.ok ? resp.response : resp.error).replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>
        </div>
      `).join('');
    }
  } catch(e) { el.innerHTML = `<span style="color:var(--red)">‚ùå ${e.message}</span>`; }
}

// ‚ïê‚ïê‚ïê KNOWLEDGE BASE ‚ïê‚ïê‚ïê
function showAddDocForm() { document.getElementById('kb-add-form').style.display = ''; }

async function loadKnowledgeDocs() {
  try {
    const res = await authFetch(API + '/api/v1/knowledge/documents');
    const data = await res.json();
    if (!data.ok) {
      document.getElementById('kb-doc-list').innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">Knowledge base not available. Check server logs.</div>';
      return;
    }
    
    document.getElementById('kb-docs').textContent = data.total_docs || 0;
    document.getElementById('kb-chunks').textContent = data.total_chunks || 0;
    
    const list = document.getElementById('kb-doc-list');
    if (!data.documents || data.documents.length === 0) {
      list.innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">No documents yet. Add knowledge for context-aware responses.</div>';
      return;
    }
    
    list.innerHTML = `<table style="width:100%;font-size:12px;border-collapse:collapse">
      <tr style="color:var(--text2);text-align:left;border-bottom:1px solid var(--border)">
        <th style="padding:8px">ID</th><th>Name</th><th>Source</th><th>Chunks</th><th></th>
      </tr>
      ${data.documents.map(d => `
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:6px">${d.id}</td>
          <td style="color:var(--accent2)">${d.name}</td>
          <td style="color:var(--text2)">${d.source}</td>
          <td>${d.chunks}</td>
          <td><button class="btn btn-outline btn-sm" onclick="removeDocument(${d.id})" style="font-size:10px;color:var(--red)">üóëÔ∏è</button></td>
        </tr>
      `).join('')}
    </table>`;
  } catch(e) { console.error('Load KB:', e); }
}

async function searchKnowledge() {
  const query = document.getElementById('kb-search-input').value.trim();
  if (!query) return;
  
  const el = document.getElementById('kb-search-results');
  el.innerHTML = '<span style="color:var(--text2)">Searching...</span>';
  
  try {
    const res = await authFetch(API + '/api/v1/knowledge/search', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query, limit: 5 })
    });
    const data = await res.json();
    if (!data.ok) { el.innerHTML = `<span style="color:var(--red)">‚ùå ${data.error}</span>`; return; }
    
    if (data.results.length === 0) {
      el.innerHTML = '<span style="color:var(--text2)">No results found.</span>';
      return;
    }
    
    el.innerHTML = data.results.map(r => `
      <div style="margin-top:8px;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px">
          <span>üìÑ ${r.doc_name} (chunk ${r.chunk_idx})</span>
          <span>Score: ${(r.score || 0).toFixed(2)}</span>
        </div>
        <div style="font-size:12px;color:var(--text)">${(r.content || '').replace(/</g,'&lt;').substring(0, 300)}${(r.content||'').length > 300 ? '...' : ''}</div>
      </div>
    `).join('');
  } catch(e) { el.innerHTML = `<span style="color:var(--red)">‚ùå ${e.message}</span>`; }
}

async function addDocument() {
  const name = document.getElementById('kb-doc-name').value.trim();
  const content = document.getElementById('kb-doc-content').value.trim();
  const source = document.getElementById('kb-doc-source').value.trim() || 'dashboard';
  if (!name || !content) { toast('Name and content are required', 'error'); return; }
  
  try {
    const res = await authFetch(API + '/api/v1/knowledge/documents', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, content, source })
    });
    const r = await res.json();
    if (r.ok) {
      toast(`üìö Document added (${r.chunks} chunks)`);
      document.getElementById('kb-add-form').style.display = 'none';
      ['kb-doc-name','kb-doc-content'].forEach(id => document.getElementById(id).value = '');
      loadKnowledgeDocs();
    } else { toast('‚ùå ' + r.error, 'error'); }
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

async function removeDocument(id) {
  try {
    const res = await authFetch(API + `/api/v1/knowledge/documents/${id}`, { method: 'DELETE' });
    const r = await res.json();
    toast(r.ok ? 'üóëÔ∏è Document removed' : '‚ùå ' + r.error);
    loadKnowledgeDocs();
  } catch(e) { toast('‚ùå ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê WEBSOCKET CHAT ‚ïê‚ïê‚ïê
let _wsReconnectAttempts = 0;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  // Include pairing code in query param (WS doesn't support custom headers)
  const codeParam = pairingCode ? '?code=' + encodeURIComponent(pairingCode) : '';
  ws = new WebSocket(proto + '//' + location.host + '/ws' + codeParam);
  ws.onopen = () => {
    _wsReconnectAttempts = 0;
    document.getElementById('ws-status').innerHTML = 'üü¢ ' + t('status.connected');
    // Send ping every 25s to keep alive
    if(window._wsPing) clearInterval(window._wsPing);
    window._wsPing = setInterval(() => { if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'ping'})); }, 25000);
  };
  ws.onclose = (ev) => {
    document.getElementById('ws-status').innerHTML = 'üî¥ ' + t('status.disconnected');
    if(window._wsPing) clearInterval(window._wsPing);
    // Exponential backoff reconnect (max 30s)
    _wsReconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(1.5, _wsReconnectAttempts), 30000);
    setTimeout(connectWS, delay);
  };
  ws.onerror = (ev) => {
    console.error('WS error:', ev);
  };
  ws.onmessage = (e) => {
    try { handleWS(JSON.parse(e.data)); } catch(err) { console.error('WS parse error:', err, e.data); }
  };
}

function handleWS(msg) {
  const el = document.getElementById('chat-messages');
  const typing = document.getElementById('chat-typing');
  switch(msg.type) {
    case 'connected':
      const agentStr = msg.agent_engine ? ' (Agent+Tools)' : ' (Direct)';
      addMsg(`üü¢ Connected ‚Äî ${msg.provider}/${msg.model}${agentStr}`, 'system');
      if (!msg.agent_engine) {
        addMsg('‚ö†Ô∏è Agent Engine not available. Chat will use direct provider calls (no tools/memory). Check Settings ‚Üí Provider config.', 'system');
      }
      break;
    case 'chat_start': typing.style.display = ''; break;
    case 'chat_chunk':
      typing.style.display = 'none';
      let s = el.querySelector('.msg-streaming');
      if (!s) { s = document.createElement('div'); s.className = 'msg msg-bot msg-streaming'; el.appendChild(s); }
      s.textContent += msg.content;
      el.scrollTop = el.scrollHeight;
      break;
    case 'chat_done':
      typing.style.display = 'none';
      const st = el.querySelector('.msg-streaming');
      if (st) st.classList.remove('msg-streaming');
      break;
    case 'chat_response': addMsg(msg.content, 'bot'); break;
    case 'chat_error':
      typing.style.display = 'none';
      const errMsg = msg.error || 'Unknown error';
      addMsg('‚ùå ' + errMsg, 'system');
      // Show helpful hints for common errors
      if (errMsg.includes('Ollama') || errMsg.includes('connection failed')) {
        addMsg('üí° Tip: Make sure Ollama is running: ollama serve', 'system');
      } else if (errMsg.includes('API key') || errMsg.includes('401')) {
        addMsg('üí° Tip: Go to Settings ‚Üí API Key and enter your provider API key', 'system');
      } else if (errMsg.includes('Agent') || errMsg.includes('not available')) {
        addMsg('üí° Tip: Go to Settings ‚Üí choose a valid provider (e.g., Ollama or OpenAI) and save', 'system');
      }
      break;
    case 'status':
      addMsg(`üìä Provider: ${msg.provider} | Model: ${msg.model} | Uptime: ${fmtUptime(msg.uptime_secs)} | Requests: ${msg.requests_processed} | Agent: ${msg.agent_engine ? '‚úÖ' : '‚ùå'}`, 'system');
      break;
    case 'pong': break; // silent
    case 'error': addMsg('‚ö†Ô∏è ' + msg.message, 'system'); break;
  }
}

function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== 1) return;
  input.value = '';

  // Slash commands
  if (text === '/status') {
    ws.send(JSON.stringify({type:'status'}));
    addMsg('/status', 'user');
    return;
  }
  if (text === '/reset') {
    document.getElementById('chat-messages').innerHTML = '<div class="msg msg-system">' + t('chat.history_cleared') + '</div>';
    return;
  }
  if (text === '/help') {
    addMsg('/help', 'user');
    addMsg(t('chat.help'), 'system');
    return;
  }

  addMsg(text, 'user');
  ws.send(JSON.stringify({type:'chat',content:text,stream:true}));
}

function addMsg(text, role) {
  const el = document.createElement('div');
  el.className = 'msg msg-' + role;
  el.textContent = text;
  document.getElementById('chat-messages').appendChild(el);
  el.parentElement.scrollTop = el.parentElement.scrollHeight;
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function fmtUptime(s) {
  if (!s) return '‚Äî';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
  return h + 'h ' + m + 'm';
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ‚ïê‚ïê‚ïê i18n ‚ïê‚ïê‚ïê
let currentLang = localStorage.getItem('bizclaw_lang') || 'vi';
const I18N = {
  vi: {
    'nav.dashboard':'B·∫£ng ƒëi·ªÅu khi·ªÉn','nav.webchat':'Tr√≤ chuy·ªán','nav.settings':'C√†i ƒë·∫∑t',
    'nav.providers':'Nh√† cung c·∫•p','nav.channels':'K√™nh li√™n l·∫°c','nav.tools':'C√¥ng c·ª•',
    'nav.brain':'Brain Engine',
    'dash.title':'B·∫£ng ƒëi·ªÅu khi·ªÉn','dash.subtitle':'Trung t√¢m qu·∫£n l√Ω Agent Gateway',
    'dash.status':'Tr·∫°ng th√°i','dash.version':'Phi√™n b·∫£n','dash.provider':'Nh√† cung c·∫•p',
    'dash.model':'M√¥ h√¨nh AI','dash.uptime':'Th·ªùi gian ho·∫°t ƒë·ªông','dash.platform':'N·ªÅn t·∫£ng',
    'dash.channels':'K√™nh ƒëang ho·∫°t ƒë·ªông',
    'th.channel':'K√™nh','th.type':'Lo·∫°i','th.status':'Tr·∫°ng th√°i','th.configured':'ƒê√£ c·∫•u h√¨nh',
    'chat.title':'Tr√≤ chuy·ªán','chat.welcome':'ƒê√£ k·∫øt n·ªëi BizClaw. Nh·∫≠p tin nh·∫Øn ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán.',
    'chat.thinking':'BizClaw ƒëang suy nghƒ©','chat.placeholder':'Nh·∫≠p tin nh·∫Øn...','chat.send':'G·ª≠i ‚Üë',
    'chat.history_cleared':'üí¨ ƒê√£ x√≥a l·ªãch s·ª≠ tr√≤ chuy·ªán',
    'chat.help':'L·ªánh c√≥ s·∫µn:\n/status ‚Äî Xem tr·∫°ng th√°i agent\n/reset ‚Äî X√≥a l·ªãch s·ª≠ chat\n/help ‚Äî Hi·ªán tr·ª£ gi√∫p',
    'status.connected':'ƒê√£ k·∫øt n·ªëi','status.disconnected':'ƒê√£ ng·∫Øt k·∫øt n·ªëi',
    'settings.title':'C√†i ƒë·∫∑t Agent','settings.subtitle':'C·∫•u h√¨nh AI agent ‚Äî nh√† cung c·∫•p, m√¥ h√¨nh, danh t√≠nh, b·∫£o m·∫≠t',
    'settings.save':'üíæ L∆∞u c√†i ƒë·∫∑t',
    'brain.title':'Brain Engine','tools.title':'C√¥ng c·ª•','providers.title':'Nh√† cung c·∫•p',
    'channels.title':'C·∫•u h√¨nh k√™nh li√™n l·∫°c','channels.subtitle':'K·∫øt n·ªëi agent v·ªõi c√°c n·ªÅn t·∫£ng nh·∫Øn tin',
    'config.title':'config.toml',
    'pairing.title':'BizClaw Agent','pairing.desc':'Nh·∫≠p m√£ Pairing Code ƒë·ªÉ truy c·∫≠p Dashboard',
    'pairing.confirm':'üîì X√°c nh·∫≠n','pairing.error':'Vui l√≤ng nh·∫≠p m√£ pairing',
  },
  en: {
    'nav.dashboard':'Dashboard','nav.webchat':'WebChat','nav.settings':'Settings',
    'nav.providers':'Providers','nav.channels':'Channels','nav.tools':'Tools',
    'nav.brain':'Brain Engine',
    'dash.title':'Dashboard','dash.subtitle':'Agent Gateway Control Panel',
    'dash.status':'Status','dash.version':'Version','dash.provider':'Provider',
    'dash.model':'AI Model','dash.uptime':'Uptime','dash.platform':'Platform',
    'dash.channels':'Active Channels',
    'th.channel':'Channel','th.type':'Type','th.status':'Status','th.configured':'Configured',
    'chat.title':'WebChat','chat.welcome':'Connected to BizClaw. Type a message to start chatting.',
    'chat.thinking':'BizClaw is thinking','chat.placeholder':'Type your message...','chat.send':'Send ‚Üë',
    'chat.history_cleared':'üí¨ Chat history cleared',
    'chat.help':'Available commands:\n/status ‚Äî Show agent status\n/reset ‚Äî Clear chat history\n/help ‚Äî Show this help',
    'status.connected':'Connected','status.disconnected':'Disconnected',
    'settings.title':'Agent Settings','settings.subtitle':'Configure your AI agent ‚Äî provider, model, identity, security',
    'settings.save':'üíæ Save Settings',
    'brain.title':'Brain Engine','tools.title':'Tools','providers.title':'Providers',
    'channels.title':'Channel Configuration','channels.subtitle':'Connect your agent to messaging platforms',
    'config.title':'config.toml',
    'pairing.title':'BizClaw Agent','pairing.desc':'Enter Pairing Code to access Dashboard',
    'pairing.confirm':'üîì Confirm','pairing.error':'Please enter pairing code',
  }
};
function t(key){ return (I18N[currentLang]||I18N.vi)[key] || (I18N.vi[key]) || key; }
function setLang(lang){
  currentLang = lang;
  localStorage.setItem('bizclaw_lang', lang);
  document.getElementById('btn-vi').style.background = lang==='vi' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-vi').style.color = lang==='vi' ? '#fff' : 'var(--text2)';
  document.getElementById('btn-en').style.background = lang==='en' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-en').style.color = lang==='en' ? '#fff' : 'var(--text2)';
  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
  // Update WS status
  if(ws && ws.readyState === 1) {
    document.getElementById('ws-status').innerHTML = 'üü¢ ' + t('status.connected');
  } else {
    document.getElementById('ws-status').innerHTML = 'üî¥ ' + t('status.disconnected');
  }
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
async function initApp(){
  setLang(currentLang);
  await loadConfig(); // Load config FIRST so settings form has data
  routeFromPath();
  loadDashboard();
  loadProviders();
  connectWS();
  setInterval(loadDashboard, 15000);
}
checkPairing();
</script>
</body>
</html>
